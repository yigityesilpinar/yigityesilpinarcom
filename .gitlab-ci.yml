image: node:12-alpine

variables:
  PROJECT_NAME: 'yigityesilpinarcom'
  DOCKER_USERNAME: 'yigityesilpinar'
  TAG: 'latest'
  DOCKER_IMAGE: '$DOCKER_USERNAME/$PROJECT_NAME:$TAG'

cache: &global_cache
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
  policy: pull-push

stages:
  - install
  - build
  - deploy

install:
  cache:
    # inherit all global cache settings
    <<: *global_cache
    # override the policy
    policy: pull-push
  stage: install
  script:
    - npm install

build:
  cache:
    # inherit all global cache settings
    <<: *global_cache
    # override the policy
    policy: pull
  stage: build
  script:
    - npm run build

deploy:
  stage: deploy
  script:
    - docker build -t $DOCKER_IMAGE .
    - docker push $DOCKER_IMAGE
    # https://docs.gitlab.com/ee/ci/ci_cd_for_external_repos/bitbucket_integration.html
    # docker tag getting-started ${DOCKER_USERNAME}/getting-started
  tags:
    - docker
